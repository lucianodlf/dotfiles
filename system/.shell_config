#!/bin/bash

# Configuración compartida para shells bash y zsh.

# Establecer un PATH más completo
export PATH="$PATH:$HOME/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$HOME/.local/bin"

# Configuración de NVM (Node Version Manager)
export NVM_DIR="$HOME/.nvm"
# Carga nvm y su completación, condicional a la versión del shell
if [ -n "$BASH_VERSION" ]; then
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
elif [ -n "$ZSH_VERSION" ]; then
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
fi

# Establecer la ubicación de los modelos de Ollama
export OLLAMA_MODELS='/home/rafiki/ollama/models'

# Configuración de Pyenv
export PYENV_ROOT="$HOME/.pyenv"
if [ -d "$PYENV_ROOT/bin" ]; then
  export PATH="$PYENV_ROOT/bin:$PATH"
  if [ -n "$BASH_VERSION" ]; then
    eval "$(pyenv init - bash)"
  elif [ -n "$ZSH_VERSION" ]; then
    eval "$(pyenv init - zsh)"
  fi
fi

# Alias para lazydocker (válido para ambos shells)
alias lzd='lazydocker'

# Cargar funciones compartidas
if [ -f "$PROJECT_DIR/system/functions.zsh" ]; then
    source "$PROJECT_DIR/system/functions.zsh"
fi

# Aumentar el límite de archivos abiertos (Bash y Zsh)
ulimit -n 2048

# --- Bloque específico para Bash ---
if [ -n "$BASH_VERSION" ]; then
  # Inicialización de Starship para Bash
  if command -v starship >/dev/null 2>&1; then
    eval "$(starship init bash)"
  fi

  # FZF para Bash
  if command -v fzf >/dev/null 2>&1; then
    export FZF_DEFAULT_COMMAND='rg --files --no-ignore --hidden --follow --glob "!.git/*" --glob "!node_modules/*" --glob "!vendor/*" --glob "!build/*" --glob "!dist/*" --glob "!target/*" --glob "!.idea/*" --glob "!.cache/*"'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_DEFAULT_OPTS='
--height 30%
--border
--cycle
--prompt=" "
--pointer="▶"
--marker="✓"
'
    #eval "$(fzf --bash)"
  fi
fi

# --- Bloque específico para Zsh ---
if [ -n "$ZSH_VERSION" ]; then
  # Eliminar entradas duplicadas del PATH (específico de Zsh)
  typeset -U PATH

  # Inicialización de Starship para Zsh
  if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
  fi

  # Completado de shell para uv (Zsh)
  if command -v uv >/dev/null 2>&1; then
    eval "$(uv generate-shell-completion zsh)"
  fi

  # Cargar plugins de Zsh
  SHARE="${PACKAGES:-/usr}"
  [ -f "$SHARE/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ] && source "$SHARE/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
  [ -f "$SHARE/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ] && source "$SHARE/share/zsh-autosuggestions/zsh-autosuggestions.zsh"

  # Autocompletado de Zsh
  fpath+=~/.zfunc
  export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=180'

  # FZF para Zsh
  if command -v fzf >/dev/null 2>&1; then
    export FZF_DEFAULT_COMMAND='rg --files --no-ignore --hidden --follow --glob "!.git/*" --glob "!node_modules/*" --glob "!vendor/*" --glob "!build/*" --glob "!dist/*" --glob "!target/*" --glob "!.idea/*" --glob "!.cache/*"'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_DEFAULT_OPTS='
--height 30%
--border
--cycle
--prompt=" "
--pointer="▶"
--marker="✓"
'
    #source <(fzf --zsh)
  fi
fi
